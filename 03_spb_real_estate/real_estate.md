# Исследование объявлений о продаже квартир

В распоряжении данные сервиса Яндекс Недвижимость — архив объявлений за несколько лет о продаже квартир в Санкт-Петербурге и соседних населённых пунктах.

Задача — выполнить предобработку данных и изучить их, чтобы найти интересные особенности и зависимости, которые существуют на рынке недвижимости.

О каждой квартире в базе содержится два типа данных: добавленные пользователем и картографические. Например, к первому типу относятся площадь квартиры, её этаж и количество балконов, ко второму — расстояния до центра города, аэропорта и ближайшего парка. 

### 1. Откройте файл с данными и изучите общую информацию. 
```
import pandas as pd
import matplotlib.pyplot as plt 
import seaborn as sns
```
```
df = pd.read_csv('/datasets/real_estate_data.csv',  sep='\t')
```
выведем первые 5 строк
```
df.head()
```
|   | total_images | last_price | total_area | first_day_exposition | rooms | ceiling_height | floors_total | living_area | floor | is_apartment | ... | kitchen_area | balcony |   locality_name | airports_nearest | cityCenters_nearest | parks_around3000 | parks_nearest | ponds_around3000 | ponds_nearest | days_exposition |
|--:|-------------:|-----------:|-----------:|---------------------:|------:|---------------:|-------------:|------------:|------:|-------------:|----:|-------------:|--------:|----------------:|-----------------:|--------------------:|-----------------:|--------------:|-----------------:|--------------:|----------------:|
| 0 | 20           | 13000000.0 | 108.0      | 2019-03-07T00:00:00  | 3     | 2.70           | 16.0         | 51.0        | 8     | NaN          | ... | 25.0         | NaN     | Санкт-Петербург | 18863.0          | 16028.0             | 1.0              | 482.0         | 2.0              | 755.0         | NaN             |
| 1 | 7            | 3350000.0  | 40.4       | 2018-12-04T00:00:00  | 1     | NaN            | 11.0         | 18.6        | 1     | NaN          | ... | 11.0         | 2.0     | посёлок Шушары  | 12817.0          | 18603.0             | 0.0              | NaN           | 0.0              | NaN           | 81.0            |
| 2 | 10           | 5196000.0  | 56.0       | 2015-08-20T00:00:00  | 2     | NaN            | 5.0          | 34.3        | 4     | NaN          | ... | 8.3          | 0.0     | Санкт-Петербург | 21741.0          | 13933.0             | 1.0              | 90.0          | 2.0              | 574.0         | 558.0           |
| 3 | 0            | 64900000.0 | 159.0      | 2015-07-24T00:00:00  | 3     | NaN            | 14.0         | NaN         | 9     | NaN          | ... | NaN          | 0.0     | Санкт-Петербург | 28098.0          | 6800.0              | 2.0              | 84.0          | 3.0              | 234.0         | 424.0           |
| 4 | 2            | 10000000.0 | 100.0      | 2018-06-19T00:00:00  | 2     | 3.03           | 14.0         | 32.0        | 13    | NaN          | ... | 41.0         | NaN     | Санкт-Петербург | 31856.0          | 8098.0              | 2.0              | 112.0         | 1.0              | 48.0          | 121.0           |

изучим общую информацию о датафрейме
```
df.info()
```
```
<class 'pandas.core.frame.DataFrame'>
RangeIndex: 23699 entries, 0 to 23698
Data columns (total 22 columns):
 #   Column                Non-Null Count  Dtype  
---  ------                --------------  -----  
 0   total_images          23699 non-null  int64  
 1   last_price            23699 non-null  float64
 2   total_area            23699 non-null  float64
 3   first_day_exposition  23699 non-null  object 
 4   rooms                 23699 non-null  int64  
 5   ceiling_height        14504 non-null  float64
 6   floors_total          23613 non-null  float64
 7   living_area           21796 non-null  float64
 8   floor                 23699 non-null  int64  
 9   is_apartment          2775 non-null   object 
 10  studio                23699 non-null  bool   
 11  open_plan             23699 non-null  bool   
 12  kitchen_area          21421 non-null  float64
 13  balcony               12180 non-null  float64
 14  locality_name         23650 non-null  object 
 15  airports_nearest      18157 non-null  float64
 16  cityCenters_nearest   18180 non-null  float64
 17  parks_around3000      18181 non-null  float64
 18  parks_nearest         8079 non-null   float64
 19  ponds_around3000      18181 non-null  float64
 20  ponds_nearest         9110 non-null   float64
 21  days_exposition       20518 non-null  float64
dtypes: bool(2), float64(14), int64(3), object(3)
memory usage: 3.7+ MB
```
Построим общую гистограмму для всех столбцов таблицы.
```
df.hist(figsize=(15, 20))
```
![cover](https://github.com/vs-gorgan/practicum.yandex/blob/main/03_spb_real_estate/hist.png)

### 2. Предобработка данных

**2.1. Удаление пропусков**

Определим число прокусков для каждого столбца. Создадим переменную `skip`
```
skip = pd.DataFrame(df.isna().sum()) \
    .rename(columns={0: 'before'})
skip
```
|                      | before |
|---------------------:|-------:|
|     total_images     | 0      |
|      last_price      | 0      |
|      total_area      | 0      |
| first_day_exposition | 0      |
|         rooms        | 0      |
|    ceiling_height    | 9195   |
|     floors_total     | 86     |
|      living_area     | 1903   |
|         floor        | 0      |
|     is_apartment     | 20924  |
|        studio        | 0      |
|       open_plan      | 0      |
|     kitchen_area     | 2278   |
|        balcony       | 11519  |
|     locality_name    | 49     |
|   airports_nearest   | 5542   |
|  cityCenters_nearest | 5519   |
|   parks_around3000   | 5518   |
|     parks_nearest    | 15620  |
|   ponds_around3000   | 5518   |
|     ponds_nearest    | 14589  |
|    days_exposition   | 3181   |

Пропуски данных в:

`ceiling_height` — высота потолков (м)
Сгруппируем данные по этажам. Заполним медианным значением.

`floors_total` — всего этажей в доме

`living_area` — жилая площадь в квадратных метрах (м²)

`is_apartment` — апартаменты (булев тип)
Всего 23,6 тыс строк. Данные отсутствуют в 21 тыс строк.
Вкорее всего если ответ отрицательный, т.е. не аппартаменты - значение отсутствует.
Установм False для пропусков.

`kitchen_area` — площадь кухни в квадратных метрах (м²)

`balcony` — число балконов
При заполнении пропусков применим аналогочный с апартаментами метод.
Пропуски заменим на ноль.

`locality_name` — название населённого пункта

`airports_nearest` — расстояние до ближайшего аэропорта в метрах (м)

`cityCenters_nearest` — расстояние до центра города (м)

`parks_around3000` — число парков в радиусе 3 км

`parks_nearest` — расстояние до ближайшего парка (м)

`ponds_around3000` — число водоёмов в радиусе 3 км

`ponds_nearest` — расстояние до ближайшего водоёма (м)

`days_exposition` — сколько дней было размещено объявление (от публикации до снятия)

Начнём заполнение пропусков в колонке с количеством балконов. Скорее всего в квартирах с пропущенными значениями нет балконов
```
# заменим пропуски данных в колонке с числом балконов на ноль
df['balcony'] = df['balcony'].fillna(0)

# для столбца balcony установим тип float. 
df['balcony'] = pd.to_numeric(df['balcony'])
```
```
# число балконов всегда целое число. Установим тип int
df['balcony'] = df['balcony'].astype(int)
df['balcony'].value_counts()
```
```
0    15277
1     4195
2     3659
5      304
4      183
3       81
Name: balcony, dtype: int64
```
Колонка `ceiling_height` имеет 9195 пропусков. Установим для неё корректный тип данных. В данном случае нам нужны вещественные числа.
```
df['ceiling_height'] = pd.to_numeric(df['ceiling_height'], errors='coerce') # переведём значение столбца в тип float
ceiling_height = df['ceiling_height'] # извлечем столбец с высотой потолков в отдельный список
ceiling_height = ceiling_height.sort_values() # примените к нему метод сортировки
ceiling_height_unique = ceiling_height.unique() # выведем уникальные значения
ceiling_height_unique
```
```
array([  1.  ,   1.2 ,   1.75,   2.  ,   2.2 ,   2.25,   2.3 ,   2.34,
         2.4 ,   2.45,   2.46,   2.47,   2.48,   2.49,   2.5 ,   2.51,
         2.52,   2.53,   2.54,   2.55,   2.56,   2.57,   2.58,   2.59,
         2.6 ,   2.61,   2.62,   2.63,   2.64,   2.65,   2.66,   2.67,
         2.68,   2.69,   2.7 ,   2.71,   2.72,   2.73,   2.74,   2.75,
         2.76,   2.77,   2.78,   2.79,   2.8 ,   2.81,   2.82,   2.83,
         2.84,   2.85,   2.86,   2.87,   2.88,   2.89,   2.9 ,   2.91,
         2.92,   2.93,   2.94,   2.95,   2.96,   2.97,   2.98,   2.99,
         3.  ,   3.01,   3.02,   3.03,   3.04,   3.05,   3.06,   3.07,
         3.08,   3.09,   3.1 ,   3.11,   3.12,   3.13,   3.14,   3.15,
         3.16,   3.17,   3.18,   3.2 ,   3.21,   3.22,   3.23,   3.24,
         3.25,   3.26,   3.27,   3.28,   3.29,   3.3 ,   3.31,   3.32,
         3.33,   3.34,   3.35,   3.36,   3.37,   3.38,   3.39,   3.4 ,
         3.42,   3.43,   3.44,   3.45,   3.46,   3.47,   3.48,   3.49,
         3.5 ,   3.51,   3.52,   3.53,   3.54,   3.55,   3.56,   3.57,
         3.58,   3.59,   3.6 ,   3.62,   3.63,   3.65,   3.66,   3.67,
         3.68,   3.69,   3.7 ,   3.75,   3.76,   3.78,   3.8 ,   3.82,
         3.83,   3.84,   3.85,   3.86,   3.87,   3.88,   3.9 ,   3.93,
         3.95,   3.98,   4.  ,   4.06,   4.1 ,   4.14,   4.15,   4.19,
         4.2 ,   4.25,   4.3 ,   4.37,   4.4 ,   4.45,   4.5 ,   4.65,
         4.7 ,   4.8 ,   4.9 ,   5.  ,   5.2 ,   5.3 ,   5.5 ,   5.6 ,
         5.8 ,   6.  ,   8.  ,   8.3 ,  10.3 ,  14.  ,  20.  ,  22.6 ,
        24.  ,  25.  ,  26.  ,  27.  ,  27.5 ,  32.  , 100.  ,    nan])
```
Выделяются значения более 20. Вероятно, был установлен неверный формат.
```
# посмотрим информацию о недвижимости с высотой потолка более 20 м
df.query('ceiling_height > 20')
```
|       | total_images | last_price | total_area | first_day_exposition | rooms | ceiling_height | floors_total | living_area | floor | is_apartment | ... | kitchen_area | balcony |                   locality_name | airports_nearest | cityCenters_nearest | parks_around3000 | parks_nearest | ponds_around3000 | ponds_nearest | days_exposition |
|------:|-------------:|-----------:|-----------:|---------------------:|------:|---------------:|-------------:|------------:|------:|-------------:|----:|-------------:|--------:|--------------------------------:|-----------------:|--------------------:|-----------------:|--------------:|-----------------:|--------------:|----------------:|
|  355  | 17           | 3600000.0  | 55.2       | 2018-07-12T00:00:00  | 2     | 25.0           | 5.0          | 32.0        | 2     | False        | ... | NaN          | 2       | Гатчина                         | NaN              | NaN                 | NaN              | NaN           | NaN              | NaN           | 259.0           |
|  3148 | 14           | 2900000.0  | 75.0       | 2018-11-12T00:00:00  | 3     | 32.0           | 3.0          | 53.0        | 2     | NaN          | ... | 8.0          | 0       | Волхов                          | NaN              | NaN                 | NaN              | NaN           | NaN              | NaN           | NaN             |
|  4643 | 0            | 4300000.0  | 45.0       | 2018-02-01T00:00:00  | 2     | 25.0           | 9.0          | 30.0        | 2     | NaN          | ... | 7.0          | 1       | Санкт-Петербург                 | 12016.0          | 13256.0             | 1.0              | 658.0         | 1.0              | 331.0         | 181.0           |
|  4876 | 7            | 3000000.0  | 25.0       | 2017-09-27T00:00:00  | 0     | 27.0           | 25.0         | 17.0        | 17    | NaN          | ... | NaN          | 2       | посёлок Мурино                  | NaN              | NaN                 | NaN              | NaN           | NaN              | NaN           | 28.0            |
|  5076 | 0            | 3850000.0  | 30.5       | 2018-10-03T00:00:00  | 1     | 24.0           | 5.0          | 19.5        | 1     | True         | ... | 5.5          | 0       | Санкт-Петербург                 | 29686.0          | 8389.0              | 3.0              | 397.0         | 1.0              | 578.0         | 7.0             |
|  5246 | 0            | 2500000.0  | 54.0       | 2017-10-13T00:00:00  | 2     | 27.0           | 5.0          | 30.0        | 3     | NaN          | ... | 9.0          | 2       | деревня Мины                    | NaN              | NaN                 | NaN              | NaN           | NaN              | NaN           | 540.0           |
|  5669 | 4            | 4400000.0  | 50.0       | 2017-08-08T00:00:00  | 2     | 26.0           | 9.0          | 21.3        | 3     | NaN          | ... | 7.0          | 2       | Санкт-Петербург                 | 28981.0          | 10912.0             | 1.0              | 305.0         | 0.0              | NaN           | 267.0           |
|  5807 | 17           | 8150000.0  | 80.0       | 2019-01-09T00:00:00  | 2     | 27.0           | 36.0         | 41.0        | 13    | NaN          | ... | 12.0         | 5       | Санкт-Петербург                 | 18732.0          | 20444.0             | 0.0              | NaN           | 3.0              | 80.0          | 38.0            |
|  6246 | 6            | 3300000.0  | 44.4       | 2019-03-25T00:00:00  | 2     | 25.0           | 5.0          | 31.3        | 5     | NaN          | ... | 5.7          | 0       | Кронштадт                       | 68923.0          | 50649.0             | 1.0              | 417.0         | 2.0              | 73.0          | NaN             |
|  9379 | 5            | 3950000.0  | 42.0       | 2017-03-26T00:00:00  | 3     | 25.0           | 5.0          | 30.0        | 2     | NaN          | ... | 5.2          | 0       | Санкт-Петербург                 | 11647.0          | 13581.0             | 0.0              | NaN           | 0.0              | NaN           | NaN             |
| 10773 | 8            | 3800000.0  | 58.0       | 2017-10-13T00:00:00  | 2     | 27.0           | 10.0         | 30.1        | 3     | False        | ... | 8.1          | 2       | посёлок Мурино                  | NaN              | NaN                 | NaN              | NaN           | NaN              | NaN           | 71.0            |
| 11285 | 0            | 1950000.0  | 37.0       | 2019-03-20T00:00:00  | 1     | 25.0           | 5.0          | 17.0        | 4     | False        | ... | 9.0          | 2       | Луга                            | NaN              | NaN                 | NaN              | NaN           | NaN              | NaN           | 18.0            |
| 14382 | 9            | 1700000.0  | 35.0       | 2015-12-04T00:00:00  | 1     | 25.0           | 5.0          | 20.0        | 2     | False        | ... | 8.0          | 1       | поселок Новый Свет              | NaN              | NaN                 | NaN              | NaN           | NaN              | NaN           | 206.0           |
| 17857 | 1            | 3900000.0  | 56.0       | 2017-12-22T00:00:00  | 3     | 27.0           | 5.0          | 33.0        | 4     | False        | ... | NaN          | 0       | Санкт-Петербург                 | 41030.0          | 15543.0             | 0.0              | NaN           | 0.0              | NaN           | 73.0            |
| 18545 | 6            | 3750000.0  | 43.0       | 2019-03-18T00:00:00  | 2     | 25.0           | 5.0          | 29.0        | 3     | False        | ... | NaN          | 0       | Санкт-Петербург                 | 27054.0          | 8033.0              | 1.0              | 540.0         | 0.0              | NaN           | 12.0            |
| 20478 | 11           | 8000000.0  | 45.0       | 2017-07-18T00:00:00  | 1     | 27.0           | 4.0          | 22.0        | 2     | NaN          | ... | 10.0         | 1       | Санкт-Петербург                 | 18975.0          | 3246.0              | 0.0              | NaN           | 3.0              | 449.0         | 429.0           |
| 20507 | 12           | 5950000.0  | 60.0       | 2018-02-19T00:00:00  | 2     | 22.6           | 14.0         | 35.0        | 11    | NaN          | ... | 13.0         | 1       | Санкт-Петербург                 | 27028.0          | 12570.0             | 0.0              | NaN           | 0.0              | NaN           | 40.0            |
| 21377 | 19           | 4900000.0  | 42.0       | 2017-04-18T00:00:00  | 1     | 27.5           | 24.0         | 37.7        | 19    | False        | ... | 11.0         | 2       | Санкт-Петербург                 | 42742.0          | 9760.0              | 0.0              | NaN           | 0.0              | NaN           | 61.0            |
| 21824 | 20           | 2450000.0  | 44.0       | 2019-02-12T00:00:00  | 2     | 27.0           | 2.0          | 38.0        | 2     | False        | ... | 8.6          | 2       | городской поселок Большая Ижора | NaN              | NaN                 | NaN              | NaN           | NaN              | NaN           | NaN             |
| 22336 | 19           | 9999000.0  | 92.4       | 2019-04-05T00:00:00  | 2     | 32.0           | 6.0          | 55.5        | 5     | False        | ... | 16.5         | 4       | Санкт-Петербург                 | 18838.0          | 3506.0              | 0.0              | NaN           | 3.0              | 511.0         | NaN             |
| 22869 | 0            | 15000000.0 | 25.0       | 2018-07-25T00:00:00  | 1     | 100.0          | 5.0          | 14.0        | 5     | True         | ... | 11.0         | 5       | Санкт-Петербург                 | 34963.0          | 8283.0              | 1.0              | 223.0         | 3.0              | 30.0          | 19.0            |
| 22938 | 14           | 4000000.0  | 98.0       | 2018-03-15T00:00:00  | 4     | 27.0           | 2.0          | 73.0        | 2     | True         | ... | 9.0          | 1       | деревня Нижняя                  | NaN              | NaN                 | NaN              | NaN           | NaN              | NaN           | 27.0            |

Одноэтажных зданий в списке нет. Многоэтажные здания с высотой потолка каждого этажа более 20 м не могут быть. Есть одна строка с высотой потолка 100 м. Тут явно ошибка, удалим её.

```
df = df[df.ceiling_height != 100]
```
```
# для значений более 20 м уменьшим десятичный разряд
df['ceiling_height'].where(~(df.ceiling_height > 20), other=ceiling_height/10, inplace=True)
```
```
# заполним пропуски медианным значением выполнив группировку по количеству этажей
df['ceiling_height'] = df['ceiling_height'] \
    .fillna(df.groupby('floors_total')['ceiling_height'] \
    .transform('median'))
```
```
# посмотрим количество объявлений с высотой потолка более 4 м
df.query('ceiling_height > 4').count()
```
```
total_images            53
last_price              53
total_area              53
first_day_exposition    53
rooms                   53
ceiling_height          53
floors_total            53
living_area             47
floor                   53
is_apartment             9
studio                  53
open_plan               53
kitchen_area            44
balcony                 53
locality_name           53
airports_nearest        45
cityCenters_nearest     48
parks_around3000        48
parks_nearest           31
ponds_around3000        48
ponds_nearest           31
days_exposition         44
dtype: int64
```
```
# 53 шт. Значения редкие, удалим эти строки
df = df[df.ceiling_height < 4]
```
```
# Исключим объявления с высотой потолков более 10.3 м
df = df[df.ceiling_height < 10.3]
```
```
df['ceiling_height'].isna().sum()
0
```
Продолжим заполняит пропуски. Посмотрим их количество в остальных столбцах
```
df.isna().sum()
```
```
total_images                0
last_price                  0
total_area                  0
first_day_exposition        0
rooms                       0
ceiling_height              0
floors_total                9
living_area              1865
floor                       0
is_apartment            20771
studio                      0
open_plan                   0
kitchen_area             2224
balcony                     0
locality_name              47
airports_nearest         5521
cityCenters_nearest      5501
parks_around3000         5500
parks_nearest           15539
ponds_around3000         5500
ponds_nearest           14523
days_exposition          3153
dtype: int64
```
Число пропусков в количественных величинах, связанных с площадью:

`total_area` - 0

`living_area` - 1865

`kitchen_area` - 2224

1. вычтем из общей площади - жилую площадь
2. вычтем из общей площади - площадь кухни
3. для оставшихся пропусков применим медиану
```
df['living_area'] = df['living_area'].fillna(df['total_area'] - df['kitchen_area'])
df['kitchen_area'] = df['kitchen_area'].fillna(df['total_area'] - df['living_area'])
```
|              | было | стало |
|--------------|------|-------|
| total_area   | 0    | 0     |
| living_area  | 1865 | 1427  |
| kitchen_area | 2224 | 1427  |
```
df.total_area.describe()
```
```
count    23528.000000
mean        60.075257
std         34.863304
min         12.000000
25%         40.000000
50%         52.000000
75%         69.500000
max        900.000000
Name: total_area, dtype: float64
```
Применим функцию, которая создаст категории общей площади в разбивке по квантилям.

- до 40 м2
- до 52 м2
- до 69 м2
- более 70 м2
```
# функция по разбивке общей площади ка натегории
def total_area_quantile(total_area):
    if total_area < 40:
        return 1
    elif total_area < 52:
        return 2
    elif total_area < 69:
        return 3
    return 4
```
```
# заполним новый столбец категориями общей площади
df['total_area_quantile'] = df['total_area'].apply(total_area_quantile)
```
```
# заполним пропуски жилой площади медианными значениями
df['living_area'] = df['living_area'].fillna(df.groupby('total_area_quantile')['living_area'].transform('median'))
```
```
# заполним пропуски площади кухни путём разницы общей площади имедианного значения жилой площади
df['kitchen_area'] = df['kitchen_area'].fillna(df['total_area'] - df['living_area'])
```
```
# заменим пропуски в характеристике апартаменты на Falce
df['is_apartment'] = df['is_apartment'].fillna('Falce')
```
```
# заменим пропуски в количестве этажей на unknown
df['floors_total'] = df['floors_total'].fillna(df['floor'])
```
Ранее была создана переменная `skip`. Добавим в неё колонку с информацией после заполнения пропусков.
```
skip_after = pd.DataFrame(df.isna().sum()) \
    .rename(columns={0: 'after'})
skip['after'] = skip_after['after']
skip
```
|               before | after |       |
|---------------------:|------:|-------|
|     total_images     | 0     | 0     |
|      last_price      | 0     | 0     |
|      total_area      | 0     | 0     |
| first_day_exposition | 0     | 0     |
|         rooms        | 0     | 0     |
|    ceiling_height    | 9195  | 0     |
|     floors_total     | 86    | 0     |
|      living_area     | 1903  | 0     |
|         floor        | 0     | 0     |
|     is_apartment     | 20924 | 0     |
|        studio        | 0     | 0     |
|       open_plan      | 0     | 0     |
|     kitchen_area     | 2278  | 0     |
|        balcony       | 11519 | 0     |
|     locality_name    | 49    | 47    |
|   airports_nearest   | 5542  | 5521  |
|  cityCenters_nearest | 5519  | 5501  |
|   parks_around3000   | 5518  | 5500  |
|     parks_nearest    | 15620 | 15539 |
|   ponds_around3000   | 5518  | 5500  |
|     ponds_nearest    | 14589 | 14523 |
|    days_exposition   | 3181  | 3153  |

**2.2  Изменение типов данных**

С помощью метода `info` посмотрим тип даннык каждой колонки
```
df.info()
```
```
<class 'pandas.core.frame.DataFrame'>
Int64Index: 23528 entries, 0 to 23698
Data columns (total 23 columns):
 #   Column                Non-Null Count  Dtype  
---  ------                --------------  -----  
 0   total_images          23528 non-null  int64  
 1   last_price            23528 non-null  float64
 2   total_area            23528 non-null  float64
 3   first_day_exposition  23528 non-null  object 
 4   rooms                 23528 non-null  int64  
 5   ceiling_height        23528 non-null  float64
 6   floors_total          23528 non-null  float64
 7   living_area           23528 non-null  float64
 8   floor                 23528 non-null  int64  
 9   is_apartment          23528 non-null  object 
 10  studio                23528 non-null  bool   
 11  open_plan             23528 non-null  bool   
 12  kitchen_area          23528 non-null  float64
 13  balcony               23528 non-null  int64  
 14  locality_name         23481 non-null  object 
 15  airports_nearest      18007 non-null  float64
 16  cityCenters_nearest   18027 non-null  float64
 17  parks_around3000      18028 non-null  float64
 18  parks_nearest         7989 non-null   float64
 19  ponds_around3000      18028 non-null  float64
 20  ponds_nearest         9005 non-null   float64
 21  days_exposition       20375 non-null  float64
 22  total_area_quantile   23528 non-null  int64  
dtypes: bool(2), float64(13), int64(5), object(3)
memory usage: 4.0+ MB
```
```
# при массовой смене типа с object на float можно мспользовать цикл
# в нашем случае менять надо колонку с датой/временем
    for col in columns:
        df[col] = pd.to_numeric(df[col], errors='coerce')
```
```
# Для столбца first_day_exposition становим тип данных datetime64 (Прим. 2018-07-12T00:00:00)
df['first_day_exposition'] = pd.to_datetime(df['first_day_exposition'], format='%Y-%m-%dT%H:%M:%S')
```
```
# установим тип boolean
df['is_apartment'] = df['is_apartment'].astype('bool')
```
**2.3  Дубликаты**
```
# подсчёт явных дубликатов
df.duplicated().sum()
0
```
```
# создадим новый столбец для названий населенных пунктов
df['locality_name_new'] = df['locality_name']
```
```
# посмотрим отсортированный перечень уникальных наименований.
df.locality_name.sort_values().unique()
```
```
array(['Бокситогорск', 'Волосово', 'Волхов', 'Всеволожск', 'Выборг',
       'Высоцк', 'Гатчина', 'Зеленогорск', 'Ивангород', 'Каменногорск',
       'Кингисепп', 'Кириши', 'Кировск', 'Колпино', 'Коммунар',
       'Красное Село', 'Кронштадт', 'Кудрово', 'Лодейное Поле',
       'Ломоносов', 'Луга', 'Любань', 'Мурино', 'Никольское',
       'Новая Ладога', 'Отрадное', 'Павловск', 'Петергоф', 'Пикалёво',
       'Подпорожье', 'Приморск', 'Приозерск', 'Пушкин', 'Санкт-Петербург',
       'Светогорск', 'Сертолово', 'Сестрорецк', 'Сланцы', 'Сосновый Бор',
       'Сясьстрой', 'Тихвин', 'Тосно', 'Шлиссельбург',
       'городской поселок Большая Ижора', 'городской поселок Янино-1',
       'городской посёлок Будогощь', 'городской посёлок Виллози',
       'городской посёлок Лесогорский', 'городской посёлок Мга',
       'городской посёлок Назия', 'городской посёлок Новоселье',
       'городской посёлок Павлово', 'городской посёлок Рощино',
       'городской посёлок Свирьстрой', 'городской посёлок Советский',
       'городской посёлок Фёдоровское', 'городской посёлок Янино-1',
       'деревня Агалатово', 'деревня Аро', 'деревня Батово',
       'деревня Бегуницы', 'деревня Белогорка', 'деревня Большая Вруда',
       'деревня Большая Пустомержа', 'деревня Большие Колпаны',
       'деревня Большое Рейзино', 'деревня Большой Сабск', 'деревня Бор',
       'деревня Борисова Грива', 'деревня Ваганово', 'деревня Вартемяги',
       'деревня Вахнова Кара', 'деревня Выскатка', 'деревня Гарболово',
       'деревня Глинка', 'деревня Горбунки', 'деревня Гостилицы',
       'деревня Заклинье', 'деревня Заневка', 'деревня Зимитицы',
       'деревня Извара', 'деревня Иссад', 'деревня Калитино',
       'деревня Кальтино', 'деревня Камышовка', 'деревня Каськово',
       'деревня Келози', 'деревня Кипень', 'деревня Кисельня',
       'деревня Колтуши', 'деревня Коркино', 'деревня Котлы',
       'деревня Кривко', 'деревня Кудрово', 'деревня Кузьмолово',
       'деревня Курковицы', 'деревня Куровицы', 'деревня Куттузи',
       'деревня Лаврики', 'деревня Лаголово', 'деревня Лампово',
       'деревня Лесколово', 'деревня Лопухинка', 'деревня Лупполово',
       'деревня Малая Романовка', 'деревня Малое Верево',
       'деревня Малое Карлино', 'деревня Малые Колпаны',
       'деревня Мануйлово', 'деревня Меньково', 'деревня Мины',
       'деревня Мистолово', 'деревня Ненимяки', 'деревня Нижние Осельки',
       'деревня Нижняя', 'деревня Низино', 'деревня Новое Девяткино',
       'деревня Новолисино', 'деревня Нурма', 'деревня Оржицы',
       'деревня Парицы', 'деревня Пельгора', 'деревня Пеники',
       'деревня Пижма', 'деревня Пикколово', 'деревня Пудомяги',
       'деревня Пустынка', 'деревня Пчева', 'деревня Рабитицы',
       'деревня Разбегаево', 'деревня Раздолье', 'деревня Разметелево',
       'деревня Рапполово', 'деревня Реброво', 'деревня Русско',
       'деревня Сижно', 'деревня Снегирёвка', 'деревня Старая',
       'деревня Старая Пустошь', 'деревня Старое Хинколово',
       'деревня Старополье', 'деревня Старосиверская',
       'деревня Старые Бегуницы', 'деревня Суоранда',
       'деревня Сяськелево', 'деревня Тарасово', 'деревня Терпилицы',
       'деревня Тихковицы', 'деревня Тойворово', 'деревня Торосово',
       'деревня Торошковичи', 'деревня Трубников Бор',
       'деревня Фалилеево', 'деревня Фёдоровское', 'деревня Хапо-Ое',
       'деревня Хязельки', 'деревня Чудской Бор', 'деревня Шпаньково',
       'деревня Щеглово', 'деревня Юкки', 'деревня Ялгино',
       'деревня Яльгелево', 'деревня Ям-Тесово',
       'коттеджный поселок Кивеннапа Север', 'коттеджный поселок Счастье',
       'коттеджный посёлок Лесное', 'поселок Аннино', 'поселок Барышево',
       'поселок Бугры', 'поселок Возрождение', 'поселок Войсковицы',
       'поселок Володарское', 'поселок Гаврилово', 'поселок Гарболово',
       'поселок Гладкое', 'поселок Глажево', 'поселок Глебычево',
       'поселок Гончарово', 'поселок Громово', 'поселок Дружноселье',
       'поселок Елизаветино', 'поселок Жилгородок', 'поселок Жилпосёлок',
       'поселок Житково', 'поселок Заводской', 'поселок Запорожское',
       'поселок Зимитицы', 'поселок Ильичёво', 'поселок Калитино',
       'поселок Каложицы', 'поселок Кингисеппский', 'поселок Кирпичное',
       'поселок Кобралово', 'поселок Кобринское', 'поселок Коммунары',
       'поселок Коробицыно', 'поселок Котельский',
       'поселок Красная Долина', 'поселок Красносельское',
       'поселок Лесное', 'поселок Лисий Нос', 'поселок Лукаши',
       'поселок Любань', 'поселок Мельниково', 'поселок Мичуринское',
       'поселок Молодцово', 'поселок Мурино', 'поселок Новый Свет',
       'поселок Новый Учхоз', 'поселок Оредеж',
       'поселок Пансионат Зелёный Бор', 'поселок Первомайское',
       'поселок Перово', 'поселок Петровское', 'поселок Победа',
       'поселок Поляны', 'поселок Почап', 'поселок Починок',
       'поселок Пушное', 'поселок Пчевжа', 'поселок Рабитицы',
       'поселок Романовка', 'поселок Ромашки', 'поселок Рябово',
       'поселок Севастьяново', 'поселок Селезнёво', 'поселок Сельцо',
       'поселок Семиозерье', 'поселок Семрино', 'поселок Серебрянский',
       'поселок Совхозный', 'поселок Старая Малукса',
       'поселок Стеклянный', 'поселок Сумино', 'поселок Суходолье',
       'поселок Тельмана', 'поселок Терволово', 'поселок Торковичи',
       'поселок Тёсово-4', 'поселок Углово', 'поселок Усть-Луга',
       'поселок Ушаки', 'поселок Цвелодубово', 'поселок Цвылёво',
       'поселок городского типа Большая Ижора',
       'поселок городского типа Вырица',
       'поселок городского типа Дружная Горка',
       'поселок городского типа Дубровка',
       'поселок городского типа Ефимовский',
       'поселок городского типа Кондратьево',
       'поселок городского типа Красный Бор',
       'поселок городского типа Кузьмоловский',
       'поселок городского типа Лебяжье',
       'поселок городского типа Лесогорский',
       'поселок городского типа Назия',
       'поселок городского типа Никольский',
       'поселок городского типа Приладожский',
       'поселок городского типа Рахья', 'поселок городского типа Рощино',
       'поселок городского типа Рябово',
       'поселок городского типа Синявино',
       'поселок городского типа Советский',
       'поселок городского типа Токсово',
       'поселок городского типа Форносово',
       'поселок городского типа имени Свердлова',
       'поселок станции Вещево', 'поселок станции Корнево',
       'поселок станции Лужайка', 'поселок станции Приветнинское',
       'посёлок Александровская', 'посёлок Алексеевка', 'посёлок Аннино',
       'посёлок Белоостров', 'посёлок Бугры', 'посёлок Возрождение',
       'посёлок Войскорово', 'посёлок Высокоключевой',
       'посёлок Гаврилово', 'посёлок Дзержинского', 'посёлок Жилгородок',
       'посёлок Ильичёво', 'посёлок Кикерино', 'посёлок Кобралово',
       'посёлок Коробицыно', 'посёлок Левашово', 'посёлок Ленинское',
       'посёлок Лисий Нос', 'посёлок Мельниково', 'посёлок Металлострой',
       'посёлок Мичуринское', 'посёлок Молодёжное', 'посёлок Мурино',
       'посёлок Мыза-Ивановка', 'посёлок Новогорелово',
       'посёлок Новый Свет', 'посёлок Пансионат Зелёный Бор',
       'посёлок Парголово', 'посёлок Перово', 'посёлок Песочный',
       'посёлок Петро-Славянка', 'посёлок Петровское',
       'посёлок Платформа 69-й километр', 'посёлок Плодовое',
       'посёлок Плоское', 'посёлок Победа', 'посёлок Поляны',
       'посёлок Понтонный', 'посёлок Пригородный', 'посёлок Пудость',
       'посёлок Репино', 'посёлок Ропша', 'посёлок Сапёрное',
       'посёлок Сапёрный', 'посёлок Сосново', 'посёлок Старая Малукса',
       'посёлок Стеклянный', 'посёлок Стрельна', 'посёлок Суйда',
       'посёлок Сумино', 'посёлок Тельмана', 'посёлок Терволово',
       'посёлок Торфяное', 'посёлок Усть-Ижора', 'посёлок Усть-Луга',
       'посёлок Форт Красная Горка', 'посёлок Шугозеро', 'посёлок Шушары',
       'посёлок Щеглово', 'посёлок городского типа Важины',
       'посёлок городского типа Вознесенье',
       'посёлок городского типа Вырица',
       'посёлок городского типа Красный Бор',
       'посёлок городского типа Кузнечное',
       'посёлок городского типа Кузьмоловский',
       'посёлок городского типа Лебяжье', 'посёлок городского типа Мга',
       'посёлок городского типа Павлово',
       'посёлок городского типа Рощино', 'посёлок городского типа Рябово',
       'посёлок городского типа Сиверский',
       'посёлок городского типа Тайцы', 'посёлок городского типа Токсово',
       'посёлок городского типа Ульяновка',
       'посёлок городского типа Форносово',
       'посёлок городского типа имени Морозова',
       'посёлок городского типа имени Свердлова',
       'посёлок при железнодорожной станции Вещево',
       'посёлок при железнодорожной станции Приветнинское',
       'посёлок станции Громово', 'посёлок станции Свирь',
       'садоводческое некоммерческое товарищество Лесная Поляна',
       'садовое товарищество Новая Ропша',
       'садовое товарищество Приладожский', 'садовое товарищество Рахья',
       'садовое товарищество Садко', 'село Копорье', 'село Никольское',
       'село Павлово', 'село Паша', 'село Путилово', 'село Рождествено',
       'село Русско-Высоцкое', 'село Старая Ладога', 'село Шум', nan],
      dtype=object)
```
Можно наводить порядок, меня посЕлок на посЁлок.

А можно исключить из названия "деревня", "посёлок" и т.д.

Оставим только имя начелённого пункта

```
# при обработке неявных дубликатов оставим только наименование населенного пункта
df['locality_name_new'] = df['locality_name_new'].str.replace('городской поселок ', '')
df['locality_name_new'] = df['locality_name_new'].str.replace('деревня ', '')
df['locality_name_new'] = df['locality_name_new'].str.replace('поселок ', '')
df['locality_name_new'] = df['locality_name_new'].str.replace('посёлок ', '')
df['locality_name_new'] = df['locality_name_new'].str.replace('городского типа ','')
df['locality_name_new'] = df['locality_name_new'].str.replace('городской ', '')
df['locality_name_new'] = df['locality_name_new'].str.replace('садовое товарищество ', '')
df['locality_name_new'] = df['locality_name_new'].str.replace('коттеджный ', '')
df['locality_name_new'] = df['locality_name_new'].str.replace('село ', '')
df['locality_name_new'] = df['locality_name_new'].str.replace('станции ', '')
df['locality_name_new'] = df['locality_name_new'].str.replace('садоводческое некоммерческое товарищество ','')
df['locality_name_new'] = df['locality_name_new'].str.replace('имени ','')
```
Обработка и удаление аномалий (редких значений)
```
# начнём с колонки `цена`
df.last_price.describe()
```
```
count    2.352800e+04
mean     6.468578e+06
std      1.068590e+07
min      1.219000e+04
25%      3.400000e+06
50%      4.600000e+06
75%      6.750000e+06
max      7.630000e+08
Name: last_price, dtype: float64
```
```
df.boxplot('last_price')
```
![изображение](https://github.com/vs-gorgan/practicum.yandex/blob/main/03_spb_real_estate/42.png)

```
# Посмотрим гистограмму
df['last_price'].hist(bins=100)
```
![изображение](https://github.com/vs-gorgan/practicum.yandex/blob/main/03_spb_real_estate/43.png)
```
# Одно значение явно выбивается. Исключим его и остальные аномально высокие
df = df[df.last_price < 20000000]
```
```
# посмотрим статистику и распределение после исключения анамального значения
df.boxplot('last_price')
```
![изображение](https://github.com/vs-gorgan/practicum.yandex/blob/main/03_spb_real_estate/45.png)
```
# повторим методику для общей площади
df.total_area.describe()
```
```
count    22834.000000
mean        56.612013
std         24.552529
min         12.000000
25%         40.000000
50%         51.000000
75%         67.000000
max        320.000000
Name: total_area, dtype: float64
```
Медианное и среднее значения почти равны. Однако максимальное сильно выделяется
```
# посмотрим одномерное распределение
df.boxplot('total_area')
```
![изображение](https://github.com/vs-gorgan/practicum.yandex/blob/main/03_spb_real_estate/47.bmp)
```
# построим гистограмму, выбрав число корзин равное 100 
df['total_area'].hist(bins=100)
```
![изображение](https://github.com/vs-gorgan/practicum.yandex/blob/main/03_spb_real_estate/48.png)
```
# удалим строки со значением более 200
df = df[df.total_area < 200]
```
```
# удалим строки со значением менее 20
df = df[df.total_area > 20]
```
```
# повторим метод для анализа числа комнат
df.rooms.describe()
```
```
count    22756.000000
mean         2.003516
std          0.967903
min          0.000000
25%          1.000000
50%          2.000000
75%          3.000000
max         11.000000
Name: rooms, dtype: float64
```
```
df.boxplot('rooms')
```
![изображение](https://github.com/vs-gorgan/practicum.yandex/blob/main/03_spb_real_estate/52.png)
```
df['rooms'].hist(range=(0, 7), bins=7)
```
![изображение](https://github.com/vs-gorgan/practicum.yandex/blob/main/03_spb_real_estate/53.png)

Вау, есть 11 комнат, а есть объявления без комнат.

Проверим. Вероятно ноль комнат это апартаменты.
```
df.query('rooms == 0').groupby('is_apartment')['is_apartment'].count()
```
```
is_apartment
False      5
True     177
Name: is_apartment, dtype: int64
```
Подтвердилось. Удалим 5 строк не относящихся к апартаментам
```
df.drop(df[(df.rooms == 0) & (df.is_apartment == False)].index, inplace=True)
```
```
# рассмотрим информацию о квартире с 11-ю комнатами
df.query('rooms > 10')
```
|     | total_images | last_price | total_area | first_day_exposition | rooms | ceiling_height | floors_total | living_area | floor | is_apartment | ... |   locality_name | airports_nearest | cityCenters_nearest | parks_around3000 | parks_nearest | ponds_around3000 | ponds_nearest | days_exposition | total_area_quantile | locality_name_new |
|----:|-------------:|-----------:|-----------:|---------------------:|------:|---------------:|-------------:|------------:|------:|-------------:|----:|----------------:|-----------------:|--------------------:|-----------------:|--------------:|-----------------:|--------------:|----------------:|--------------------:|------------------:|
| 648 | 3            | 17500000.0 | 183.7      | 2018-07-01           | 11    | 3.4            | 7.0          | 138.8       | 7     | True         | ... | Санкт-Петербург | 23606.0          | 3148.0              | 0.0              | NaN           | 0.0              | NaN           | NaN             | 4                   | Санкт-Петербург   |

Общая площадь - большая. Возможно, цена тоже соответствует рыночной стоимости. Но, нет ни одного балкона, всего 3 фото на 11 комнат, последний этаж и категория апартаменты. Это может быть нежилым помещением.

```
# Исключим объявление с 11-ю комнатами
df = df[df.rooms != 11]
```
```
# продолжим обработку аномалий в столбце этаж
df.floors_total.describe()
```
```
count    22750.000000
mean        10.764484
std          6.635072
min          1.000000
25%          5.000000
50%          9.000000
75%         16.000000
max         60.000000
Name: floors_total, dtype: float64
```
```
df.boxplot('floors_total')
```
![изображение](https://github.com/vs-gorgan/practicum.yandex/blob/main/03_spb_real_estate/59.png)
```
df['floors_total'].hist()
```
![изображение](https://github.com/vs-gorgan/practicum.yandex/blob/main/03_spb_real_estate/60.png)
```
df['floors_total'].isna().sum()
0
```
```
df.query('floors_total > 40')
```
|       | total_images | last_price | total_area | first_day_exposition | rooms | ceiling_height | floors_total | living_area | floor | is_apartment | ... |   locality_name | airports_nearest | cityCenters_nearest | parks_around3000 | parks_nearest | ponds_around3000 | ponds_nearest | days_exposition | total_area_quantile | locality_name_new |
|------:|-------------:|-----------:|-----------:|---------------------:|------:|---------------:|-------------:|------------:|------:|-------------:|----:|----------------:|-----------------:|--------------------:|-----------------:|--------------:|-----------------:|--------------:|----------------:|--------------------:|------------------:|
|  2253 | 12           | 3800000.0  | 45.5       | 2018-06-28           | 2     | 2.88           | 60.0         | 27.4        | 4     | True         | ... | Кронштадт       | 67763.0          | 49488.0             | 2.0              | 342.0         | 3.0              | 614.0         | 166.0           | 2                   | Кронштадт         |
| 16731 | 9            | 3978000.0  | 40.0       | 2018-09-24           | 1     | 2.65           | 52.0         | 10.5        | 18    | True         | ... | Санкт-Петербург | 20728.0          | 12978.0             | 1.0              | 793.0         | 0.0              | NaN           | 45.0            | 2                   | Санкт-Петербург   |

```
# уберём анамольно высокие здания из анализа
df = df[df.floors_total < 40]
```
По одному небоскрёбу из Питера и пригорода снесены. 
```
# проверим, есть ли ошибка у номере этажа
df.query('(floors_total - floor) < 0')
```
`0 rows × 24 columns`
На выходе получили ноль. Ошибок нет

```
# Посмотрим, что осталось в нашем датасете
df.shape
```
`(22748, 24)`

Вычислим на сколько меньше стало данных
```
1-22748/23699
```
`0.04012827545466058`
Количество строк сократилось на 4%. 

### 3. Посчитайте и добавьте в таблицу новые столбцы
```
# цена одного квадратного метра
df['price_m2'] = pd.to_numeric((df['last_price'] / df['total_area']), errors='coerce').round(1)
```
```
# добавим день недели публикации объявления (0 — понедельник, 1 — вторник и так далее)
df['day'] = df['first_day_exposition'].dt.weekday
```
```
# добавим месяц и год публикации объявления
df['month'] = df['first_day_exposition'].dt.month
df['year'] = df['first_day_exposition'].dt.year
```
Создадим функцию с категорией этажа `первый`, `последний`, `другой`
```
def floor_type(row):
    floors_total = row['floors_total']
    floor = row['floor']
    if floor == 1:
        return 'первый'
    elif floor == floors_total:
        return 'последний'
    return 'другой'
```
```
# применим floor_type для заполнения новой колонки
df['floor_type'] = df.apply(floor_type, axis = 1)
```
```
# переведём расстояние до центра города в километры
df['cityCenters'] = (df['cityCenters_nearest'] / 1000).round(0)
```
### 4. Проведите исследовательский анализ данных

**4.1  Изучим параметры объектов**
```
# построим гистограмму общей площади
df.plot(y = 'total_area', kind = 'hist', bins = 100, grid=True, figsize = (5,3), range = (15,200))
```
![изображение](https://github.com/vs-gorgan/practicum.yandex/blob/main/03_spb_real_estate/73.png)
```
# можно применить hist. Он автоматически подберет параметры
df['total_area'].hist(bins = 100)
```
![изображение](https://github.com/vs-gorgan/practicum.yandex/blob/main/03_spb_real_estate/74.png)

Среди объявлений недвижимости самые популярные предложения на квартиры с общей площадью от 30 до 40 м2

```
# построим гистограмму жилой площади
df['living_area'].hist(bins = 100)
```
![изображение](https://github.com/vs-gorgan/practicum.yandex/blob/main/03_spb_real_estate/75.png)

Однокомнатные квартиры захватили рынок. Странный пробел в значениях 25 м2.

Однокомнатные квартиры могут быть как малой так и большой площади. Переход на гистограмме должен быть плавным.

```
# построим гистограмму площади кухни
df['kitchen_area'].hist(bins = 100)
```
![изображение](https://github.com/vs-gorgan/practicum.yandex/blob/main/03_spb_real_estate/76.png)

Одна, две, три или четыре комнты, не имеет значения, все кухни примерно одинаковые
```
# построим гистограмму цены объекта
df['last_price'].hist(bins = 100)
```
![изображение](https://github.com/vs-gorgan/practicum.yandex/blob/main/03_spb_real_estate/77.png)
```
```
```
```
```
```
```
```
```
```
```
```
```
```
```
